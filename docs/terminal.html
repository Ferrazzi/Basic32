<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Basic32 — Serial Terminal (C64)</title>
    <link rel="stylesheet" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  </head>
  <body class="c64">
    <div class="crt"></div>

    <div class="frame">
      <!-- Logo + menu -->
      <a class="brand" href="index.html" aria-label="Home">
        <img src="https://raw.githubusercontent.com/Ferrazzi/Basic32/main/Logo.png" alt="Logo" />
      </a>
      <nav class="topnav" role="navigation" aria-label="primary">
        <a class="navitem" href="index.html">Home</a>
        <a class="navitem" href="terminal.html">Serial Monitor</a>
      </nav>

      <main class="content" style="padding-top: 60px;">
        <h1>TERMINALE SERIALE</h1>
        <p class="lead">
          Seleziona il dispositivo seriale, imposta il baud e connetti.
          Puoi leggere e inviare comandi. Line end di default: <b>none</b>.
        </p>

        <!-- Controlli -->
        <div class="controls" style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin:14px 0 6px;">
          <button id="pick">Seleziona dispositivo</button>
          <button id="connect" disabled>Connetti</button>
          <button id="disconnect" disabled>Scollega</button>
          <button id="reboot" disabled>Reboot</button>

          <label>
            Baud
            <select id="baud">
              <option>921600</option>
              <option>460800</option>
              <option selected>115200</option>
              <option>57600</option>
              <option>38400</option>
              <option>19200</option>
              <option>9600</option>
            </select>
          </label>

          <label>
            Line end
            <select id="lineend">
              <option value="" selected>(none)</option>
              <option value="\n">LF</option>
              <option value="\r">CR</option>
              <option value="\r\n">CRLF</option>
            </select>
          </label>

          <label style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" id="autoscroll" checked />
            Auto-scroll
          </label>

          <button id="cls">Clear</button>
          <button id="clsAnsi">CLS ANSI</button>
          <button id="save">Save log</button>
        </div>

        <!-- Output -->
        <div id="log" style="
          width:min(980px, 96%);
          height:420px; border:3px solid var(--c64-border); border-radius:10px;
          padding:.75rem; overflow:auto; white-space:pre-wrap;
          background: rgba(0,0,0,.12); color: var(--c64-text);
          font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;">
          [ready]
        </div>

        <!-- Input -->
        <div style="display:flex; gap:8px; margin-top:8px; width:min(980px,96%);">
          <input id="line" type="text" placeholder="Scrivi un comando e premi Invio…" style="
            flex:1 1 auto; border:3px solid var(--c64-border); border-radius:8px;
            padding:.5rem .7rem; background: rgba(0,0,0,.15); color: var(--c64-text);" />
          <button id="send">Invia</button>
        </div>

        <p class="hint">Serve Chrome/Edge su HTTPS (GitHub Pages) o <code>localhost</code>.</p>
      </main>

      <!-- Icone social -->
      <aside class="social">
        <a class="icon" href="https://t.me/Basic32ESP" target="_blank" rel="noopener" aria-label="Telegram">…</a>
        <a class="icon" href="https://github.com/Ferrazzi" target="_blank" rel="noopener" aria-label="GitHub">…</a>
      </aside>
    </div>

    <script type="module">
      if (!('serial' in navigator)) {
        alert('Questo browser non supporta la Web Serial API. Usa Chrome/Edge su desktop.');
      }

      const $ = (id) => document.getElementById(id);
      const pickBtn = $('pick');
      const connectBtn = $('connect');
      const disconnectBtn = $('disconnect');
      const rebootBtn = $('reboot');
      const baudSel = $('baud');
      const lineendSel = $('lineend');
      const autoscroll = $('autoscroll');
      const logEl = $('log');
      const lineIn = $('line');
      const sendBtn = $('send');
      const clearBtn = $('cls');
      const clsAnsiBtn = $('clsAnsi');
      const saveBtn = $('save');

      let port = null;
      let reader = null;
      let writer = null;
      let keepReading = false;

      function log(txt) {
        logEl.textContent += (logEl.textContent.endsWith('\n') ? '' : '\n') + txt;
        if (autoscroll.checked) logEl.scrollTop = logEl.scrollHeight;
      }
      function localClear() { logEl.textContent = ''; }

      async function ansiClear() {
        if (!writer) return;
        const encoder = new TextEncoder();
        await writer.write(encoder.encode('\x1b[2J\x1b[H'));
      }

      async function rebootEsp32() {
        if (!port || !port.setSignals) {
          log('[reboot non supportato]');
          return;
        }
        try {
          // classica sequenza DTR/RTS per devkit ESP
          await port.setSignals({ dataTerminalReady: false, requestToSend: true });
          await new Promise(r => setTimeout(r, 100));
          await port.setSignals({ dataTerminalReady: true, requestToSend: false });
          log('[reboot inviato]');
        } catch (e) {
          console.warn('Reboot fallito:', e);
          log('[reboot fallito]');
        }
      }

      // Device picker
      pickBtn.addEventListener('click', async () => {
        try {
          port = await navigator.serial.requestPort();
          connectBtn.disabled = false;
          log('[porta selezionata]');
        } catch {
          log('[selezione annullata]');
        }
      });

      // Connessione
      connectBtn.addEventListener('click', async () => {
        try {
          await port.open({ baudRate: Number(baudSel.value) || 115200 });
          const decoder = new TextDecoder();
          reader = port.readable.getReader();
          writer = port.writable.getWriter();
          keepReading = true;

          localClear();
          log('[connesso — reset device]');
          await rebootEsp32();

          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          rebootBtn.disabled = false;

          (async () => {
            try {
              while (keepReading) {
                const { value, done } = await reader.read();
                if (done) break;
                if (value) {
                  logEl.textContent += decoder.decode(value);
                  if (autoscroll.checked) logEl.scrollTop = logEl.scrollHeight;
                }
              }
            } finally {
              try { reader.releaseLock(); } catch {}
            }
          })();
        } catch (e) {
          alert('Connessione fallita: ' + e);
        }
      });

      // Disconnessione
      async function disconnect() {
        keepReading = false;
        try { if (reader) await reader.cancel(); } catch {}
        try { if (writer) writer.releaseLock(); } catch {}
        try { if (port) await port.close(); } catch {}
        connectBtn.disabled = !port;
        disconnectBtn.disabled = true;
        rebootBtn.disabled = true;
        log('[disconnesso]');
      }
      disconnectBtn.addEventListener('click', disconnect);
      window.addEventListener('beforeunload', () => { if (port) disconnect(); });

      // Pulsante reboot
      rebootBtn.addEventListener('click', rebootEsp32);

      // Invio
      async function sendLine() {
        if (!writer) return;
        const encoder = new TextEncoder();
        const end = lineendSel.value || '';
        const data = lineIn.value + end;
        lineIn.value = '';
        await writer.write(encoder.encode(data));
      }
      sendBtn.addEventListener('click', sendLine);
      lineIn.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendLine(); });

      // Utility
      clearBtn.addEventListener('click', localClear);
      clsAnsiBtn.addEventListener('click', ansiClear);
      saveBtn.addEventListener('click', () => {
        const blob = new Blob([logEl.textContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'serial-log.txt'; a.click();
        URL.revokeObjectURL(url);
      });
    </script>
  </body>
</html>
